-- Fix migrations table columns to match the new schema
ALTER TABLE migrations
  CHANGE COLUMN name version VARCHAR(255) NOT NULL,
  CHANGE COLUMN executed_at applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP;

-- Fix the missing comma in orgs table
ALTER TABLE orgs
  MODIFY contentful_id VARCHAR(80) NOT NULL,
  ADD COLUMN created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP AFTER contentful_id,
  ADD COLUMN updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP AFTER created_at;

-- Add short_desc column to subthemes if it doesn't exist
ALTER TABLE subthemes
  ADD COLUMN short_desc VARCHAR(255) DEFAULT NULL AFTER contentful_id;

-- Add schedule_end column to events if it doesn't exist
ALTER TABLE events
  ADD COLUMN schedule_end DATETIME DEFAULT NULL AFTER schedule;

-- Update events constraint for slug
ALTER TABLE events
  ADD UNIQUE KEY (slug);

-- Fix event_pubs foreign key reference
ALTER TABLE event_pubs
  DROP FOREIGN KEY event_id,
  MODIFY event_id INT,
  ADD CONSTRAINT fk_event_pubs_event FOREIGN KEY (event_id) REFERENCES events(id) ON DELETE CASCADE;

-- Convert TEXT fields to VARCHAR(2083)
ALTER TABLE users
  MODIFY display_picture VARCHAR(2083);

ALTER TABLE orgs
  MODIFY org_logo VARCHAR(2083),
  MODIFY org_url VARCHAR(2083);

ALTER TABLE subthemes
  MODIFY logo_pub_url VARCHAR(2083),
  MODIFY background_pub_url VARCHAR(2083);

ALTER TABLE events
  MODIFY gforms_url VARCHAR(2083) NOT NULL;

ALTER TABLE highlights
  MODIFY title_card VARCHAR(2083),
  MODIFY bg_img VARCHAR(2083);

ALTER TABLE event_pubs
  MODIFY pub_url VARCHAR(2083);

-- Add indexes to improve query performance
ALTER TABLE users
  ADD INDEX idx_users_email (email),
  ADD INDEX idx_users_google_id (google_id);

ALTER TABLE orgs
  ADD INDEX idx_orgs_contentful_id (contentful_id);

ALTER TABLE subthemes
  ADD INDEX idx_subthemes_contentful_id (contentful_id),
  ADD INDEX idx_subthemes_title (title);

ALTER TABLE events
  ADD INDEX idx_events_contentful_id (contentful_id),
  ADD INDEX idx_events_title (title),
  ADD INDEX idx_events_schedule (schedule),
  ADD INDEX idx_events_subtheme_id (subtheme_id);

ALTER TABLE registrations
  ADD INDEX idx_registrations_event_id (event_id);

ALTER TABLE highlights
  ADD INDEX idx_highlights_contentful_id (contentful_id);

ALTER TABLE event_pubs
  ADD INDEX idx_event_pubs_contentful_id (contentful_id);

ALTER TABLE bookmarks
  ADD INDEX idx_bookmarks_user_id (user_id);

-- Record this migration
INSERT INTO migrations (version) VALUES ('002_optimize_schema');
